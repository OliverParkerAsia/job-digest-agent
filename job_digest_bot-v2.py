import os
import smtplib
import time
import requests
from bs4 import BeautifulSoup
from email.mime.text import MIMEText
from openpipe import OpenAI

def get_job_digest():
    """Original version ‚Äî returns plain text."""
    client = OpenAI(
        openpipe={"api_key": os.getenv("OPENPIPE_API_KEY")}
    )

    model_id = os.getenv("MODEL_ID")
    response = client.chat.completions.create(
        model=model_id,
        messages=[
            {"role": "user", "content": """You are a job curator specializing in experimental media, digital culture, and XR positions. List 5‚Äì10 relevant job opportunities currently open in Hong Kong.

For each job, return:
- Title
- Institution
- One-line description (optional)

Format each line like this:
[1] Title at Institution ‚Äî Short Description
Return each job on a new line."""}
        ]
    )

    return response.choices[0].message.content

def search_duckduckgo(query):
    """Returns the first result link from DuckDuckGo HTML version."""
    url = "https://html.duckduckgo.com/html/"
    headers = {"User-Agent": "Mozilla/5.0"}
    data = {"q": query}
    response = requests.post(url, headers=headers, data=data)
    soup = BeautifulSoup(response.text, "html.parser")
    results = soup.find_all("a", class_="result__a")

    if results:
        return results[0]["href"]
    return None

def enrich_with_links(job_list_raw):
    import html  # just in case

    lines = job_list_raw.strip().split("\n")
    html_list = []

    for line in lines:
        if "]" not in line:
            continue  # skip broken lines

        try:
            job_text = line.split("]", 1)[1].strip()
            search_query = job_text + " site:.hk"
            url = search_duckduckgo(search_query)

            html_list.append(
                f'<li style="margin-bottom: 12px;"><a href="{html.escape(url or "#")}" style="text-decoration: none; color: #4405dd;">{html.escape(job_text)}</a></li>'
            )
            time.sleep(3.0)

        except Exception:
            html_list.append(f"<li>{html.escape(line)} (error)</li>")

    return f"<ul style='padding-left: 20px; margin-top: 0;'>{''.join(html_list)}</ul>"

def get_job_digest_enriched():
    raw = get_job_digest()
    html_list = enrich_with_links(raw)

    return f"""
    <html>
        <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f9f9f9; padding: 20px;">
            <div style="max-width: 600px; margin: auto; background-color: #ffffff; padding: 30px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.08);">
                <h2 style="margin-bottom: 20px; color: #4405dd;">üóûÔ∏è Your Daily Job Digest</h2>
                {html_list}
                <p style="font-size: 12px; color: #777; margin-top: 30px;">This message was generated by your pinkpulse job agent, {time.strftime('%B %d, %Y')}.</p>
            </div>
        </body>
    </html>
    """


def send_email(subject, body, html=False):
    msg = MIMEText(body, "html" if html else "plain")
    msg["Subject"] = subject
    msg["From"] = os.getenv("FROM_EMAIL")
    msg["To"] = os.getenv("TO_EMAIL")

    with smtplib.SMTP_SSL("smtp.gmail.com", 465) as server:
        server.login(os.getenv("FROM_EMAIL"), os.getenv("GMAIL_APP_PASSWORD"))
        server.send_message(msg)

if __name__ == "__main__":
    # Use the enriched version with links:
    digest_html = get_job_digest_enriched()
    send_email("üóûÔ∏è Your Daily Job Digest (with links)", digest_html, html=True)

    # Or fallback to plain version:
    # digest_text = get_job_digest()
    # send_email("üóûÔ∏è Your Daily Job Digest", digest_text)
